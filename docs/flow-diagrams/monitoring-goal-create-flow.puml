@startuml
!pragma useVerticalIf on
title Create Monitoring Goals Logic

start

:Load Monitoring Goal Template;

if (Template not found?) then (yes)
  :Log error;
  stop
endif

:Begin DB Transaction;

:Find grants with active monitoring citations\nand no existing Monitoring goal;

note right
  Review must have:
  - Status: 'Complete'
  - Delivery Date: Jan 21, 2025 or later
  - Review Type: FA-1, FA-2, RAN, AIAN-DEF,\nFollow-up, FA1-FR, FA2-CR, Special
  - At least one finding with status: 'Active'

  *Delivery Date = Report Received Date in HSES
end note

if (Matching grants found?) then (yes)
  :Insert new Goals using Monitoring template;
  :Mark status as 'Not Started';
  :Set source as 'monitoring';
endif

:Find existing Monitoring goals\nthat are 'Closed' or 'Suspended'\nbut have new active findings;

if (Goals to reopen?) then (yes)
  :Reopen goals;
  :Mark status as 'Not Started';
endif

note right
  If any step fails, the entire\ntransaction is rolled back.
end note

:Commit Transaction;

stop
@enduml
