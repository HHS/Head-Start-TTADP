# Infrastructure

## Overview

- The TTA Hub application(s) are run on the [cloud.gov](https://login.fr.cloud.gov/login) platform
- cloud.gov uses AWS and leverages [Cloud Foundry](https://docs.cloudfoundry.org/) tools
- CircleCI is used for automated build/test/deploy jobs, the project can be found [here](https://app.circleci.com/pipelines/github/HHS/Head-Start-TTADP).

## Architecture

- Application consists of a Node.js backend and React frontend.
- PostgreSQL is used extensively for persistant data storage.
- Redis handles caching and some realtime presence features
- AWS S3 is used for DB backups and some external data exchange

## Environments

- There are three environment "levels": prod, staging, and dev
- Each environment is isolated to its own cloud.org space
- Prod and staging follow similar configurations, with multiple instances serving incoming traffic
- There are multiple deployments within dev (blue, green, red, etc).  Each dev deployment consists of a single instance with dedicated database and redis, and has its own DNS entry.
- Dev and staging databases are restored to an anonymized version of production data every night, via a schedule job that runs via CircleCI

## Continuous Integration (CI)

The bulk of CD configurations can be found in this repo's [.circleci/config.yml](.circleci/config.yml) file, the [application manifest](manifest.yml) and the environment specific [deployment_config](deployment_config/) variable files.  Linting, unit tests, test coverage analysis, and an accessibility scan are all run automatically on each push to the HHS/Head-Start-TTADP repo. Merges to the main branch are blocked if the CI tests do not pass. The continuous integration pipeline is configured via CircleCi. The bulk of CI configurations can be found in this repo's [.circleci/config.yml](.circleci/config.yml) file. For more information on the security audit and scan tools used in the continuous integration pipeline see [ADR 0009](docs/adr/0009-security-scans.md).

## Continuous Deployment (CD)

- The `main` branch is automatically deployed to `staging` on merge, after tests pass 
- The `production` branch is automatically deployed to `production` on merge, after tests pass

### Deploy changes directly to a test environment

You can deploy changes from any remote branch to a non-production environment by following these steps:
- Log in to CircleCI, go to pipelines https://app.circleci.com/pipelines
- Select your branch from the dropdown on the top right side
- Click "Trigger Pipeline" button in the top right
- Select `deploy_manual`, choose the environment you want to deploy to (ie dev-blue) from the dropdown, then run the pipeline.

## Secret Management

CircleCI's project-based "environment variables" are used for secret management. These secrets include:

- Cloud.gov deployer account username and password. These keys are specific to each cloud.gov
  organization/space, i.e. each deployment environment, and can be [regenerated by developers][cloudgov-deployer]
  who have proper cloud.gov permissions at any time.
- HSES authentication middleware secrets passed to the application as `AUTH_CLIENT_ID` and `PRIVATE_JWK_64`.
- The application `SESSION_SECRET`.
- The application `JWT_SECRET`.
- NewRelic license key, passed to the application as `NEW_RELIC_LICENSE_KEY`

Exception:

- The environment specific postgres database URI is automatically available in the relevant cloud.gov application environment (because they share a cloud.gov "space"). The URI is accessible to the application as POSTGRES_URL. Consequently, this secret does not need to be managed by developers.

### Adding environment variables to an application
There are a few different things you will need to do in order to add a new secret or config variable, depending on whether the value is secret and whether it will change per environment or not.

* First, add it under the `env:` section in `manifest.yml`.  This is what populates values when the application is deployed to cloud.gov
* Next, add the value to each of the files under [deployment_config/](deployment_config/).
  * If the value is non-secret, simply add it in cleartext to these configs, ie `NEW_VAR: false`
  * If the value is secret, for now you will add the var name here with reference to what it will be called in CircleCI. ie `NEW_VAR: "${CIRCLE_VAR_NAME}"`
* If you created a secret-style var, you will now need to add it as a project-based "environment variable" in CircleCI.
  * Go to CircleCI [project settings](https://app.circleci.com/settings/project/github/HHS/Head-Start-TTADP/environment-variables).  You can create a separate value for each environment here, or use the same value across all environments, depending on what you defined in the deployment config yml files.

## Interacting with a deployed application or database

Read [TTAHUB-System-Operations](https://github.com/HHS/Head-Start-TTADP/wiki/TTAHUB-System-Operations) for information on how production may be accessed.

Our project includes four deployed Postgres databases, one to interact with each application environment (sandbox, dev, staging, prod). For instructions on how to create and modify databases instances within the cloud.gov ecosystem see the [terraform/README.md](terraform/README.md).

### First, log into Cloud Foundry instance

1. Install the lastest version (**Version 8** as of this writing) of the Cloud Foundry CLI tool

   - On MacOS: `brew install cloudfoundry/tap/cf-cli@8`
   - On other platforms: [Download and install cf][cf-install]. Be sure to get version 8.x

1. Login to cloud.gov account

   ```bash
   cf login -a api.fr.cloud.gov --sso
   # follow temporary authorization code prompts
   ```

1. Follow prompts to target the desired space

### Second, choose an interaction method

### Open an SSH session to a running application instance

```
cf ssh tta-smarthub-dev-blue -t -c "/tmp/lifecycle/launcher /home/vcap/app sh '{}'"
```

#### Run psql commands directly

1. If you haven't used the the cloud foundry plugin [cf-service-connect][cf-service-connect] before, install it now

   ```bash
   # Mac OSX ARM
   cf install-plugin https://github.com/cloud-gov/cf-service-connect/releases/download/v1.1.4/cf-service-connect_darwin_arm64 
   # Mac OSX non-ARM
   cf install-plugin https://github.com/cloud-gov/cf-service-connect/releases/download/v1.1.4/cf-service-connect_darwin_amd64
   # Windows
   cf install-plugin https://github.com/cloud-gov/cf-service-connect/releases/download/v1.1.4/cf-service-connect_windows_386
   # Linux
   cf install-plugin https://github.com/cloud-gov/cf-service-connect/releases/download/v1.1.4/cf-service-connect_linux_amd64
   ```

1. Connect to your desired database

   ```bash
   # list services (ie postgres, redis, etc)
   cf services
   cf connect-to-service <app_name> <service_instance_name>
   # Example for sandbox pg
   cf connect-to-service tta-smarthub-sandbox ttahub-sandbox
   # Example for sandbox redis
   cf connect-to-service tta-smarthub-sandbox ttahub-redis-sandbox
   # ctrl-d to disconnect
   ```

   On success, your terminal prompt will change to match the `db_name` from the database instance credentials.
   This indicates you are in an open psql session, the command-line interface to PostgreSQL.
   You will need to have the pg/redis client installed locally and findable in your $PATH.
   Production instances are generally inaccessible for direct connection, although this can be disabled when necessary.

   Note: This plugin will not work for connecting to a replica database.  
   Instead, use the script `./bin/replica-connect.sh` from this repo.
   ```
   ./bin/replica-connect.sh tta-smarthub-dev-blue
    Establishing SSH tunnel with PID: 38115
    Connecting to db replica for tta-smarthub-dev-blue on port 5432...
    cgawsbrokerprodbt584djy6n6cnuz=> 
    ```

#### Run script as task

1. Use [cf run-task][cf-run-task] command

   ```bash
   cf run-task <app_name> --command "<yarn command>"
   # Example 1: running data validation script against sandbox
   cf run-task tta-smarthub-sandbox --command "yarn db:validation"
   # Example 2: undo most recent database migration
   cf run-task tta-smarthub-sandbox --command "yarn db:migrate:undo:prod:last"
   ```

1. Check log output, including those from task

   ```bash
   cf logs <app_name> --recent
   # Example 1: checking sandbox logs
   cf logs tta-smarthub-sandbox --recent
   # Example 2: checking sandbox logs, grep just for task logs
   cf logs tta-smarthub-sandbox --recent | grep APP/TASK/
   ```

#### Run script in an interactive shell

1. If on prod, enable shh in space first

   ```bash
   cf allow-space-ssh ttahub-prod
   ```

1. Ssh into your desired application (to see application names run `cf apps`)

   ```bash
   cf ssh <app_name>
   # ssh example for sandbox application
   cf ssh tta-smarthub-sandbox
   ```

1. Open shell

   ```bash
   /tmp/lifecycle/shell
   ```

1. Run your desired command

   ```bash
   # example
   node ./build/server/src/tools/dataValidationCLI.js
   ```

1. If on prod, disable ssh in space

   ```bash
   cf disallow-space-ssh ttahub-prod
   ```

#### Example: Manual import of Monitoring data

Importing Monitoring data without the automation uses Option C above across several step and is described further on in the [tools README](https://github.com/HHS/Head-Start-TTADP/tree/main/src/tools).

## Taking a production backup via CircleCI

We can quickly take a production backup via the CircleCI web interface. To do so, go to the `production` branch there and trigger a pipeline with the variable `manual-trigger` set to true. You can then retrieve this backup with the script `bin/latest_backup.sh`.

## Data in non-production environments

In order to keep the non-production environments as close to production as possible we developed a way to transform a restored version of the production database locally if using local database. This process is run automatically every night, so all non-prod envs will have a fresh, anonymized database each morning.

### Running a db refresh manually

While process does run every night automatically, it can also be run on-demand via CircleCI or by executing the script directly.

The script can be run using the following:

```
yarn processData:local
```

The transformed database can then be restored in the non-production environments.
For details on how to perform a backup and restore, there is information on the cloud.gov site:

<https://cloud.gov/docs/management/database-backup-restore/>

**Refreshing data in non-production environments**

In order to keep the non-production environments as close to production as possible we developed a way to transform a restored version of the production database locally if using local database. The script can be run using the following:

```
yarn processData:local
```

The transformed database can then be restored in the non-production environments.
For details on how to perform a backup and restore, there is information on the cloud.gov site:

<https://cloud.gov/docs/management/database-backup-restore/>

## Using Maintenance Mode

if you need to put the application into maintenance mode, you can run the maintenance script located at `bin/maintenance`.

This script require that you have [Cloud Foundry's CLI v7](https://github.com/cloudfoundry/cli/wiki/V7-CLI-Installation-Guide) installed to run.

The script takes two flags

- \-m | \-\-maintenance\-mode controls whether the script takes the app into maintenance mode or out of it.
  - Options are "on" or "off
- \-e | \-\-environment controls which environment you are targeting.
  - Options are "sandbox", "dev", "staging", and "prod"

Ex.

```
# Puts the dev environment into maintenance mode
./bin/maintenance -e dev -m on
```

If you are not logged into the cf cli, it will ask you for an sso temporary password. You can get a temporary password at https://login.fr.cloud.gov/passcode. The application will stay in maintenance mode even through deploys of the application. You need to explicitly run `./bin/maintenance -e ${env} -m off` to turn off maintenance mode.


## Creating a new environment

```
cf login -a api.fr.cloud.gov --sso
cf create-service aws-rds [size] [name] // ex micro-psql, ttahub-dev-green
cf create-service aws-elasticache-redis [size] [name] // ex redis-dev ttahub-redis-dev-green
cf create-service s3 [size] [name] // ex basic ttahub-document-upload-dev-green
```

Update the contentSecurityPolicy in app.js with the new full hostname.
Contact cloud.gov to allow the new routing

If you need to bind an identity provider:

```
# a provider can be reused within the same space
 cf create-service cloud-gov-identity-provider oauth-client oauth-provider-dev

 # create a service key for each env
 cf create-service-key \
     oauth-provider-dev \
     oauth-key-dev-green \
     -c '{
         "redirect_uri": [
             "https://tta-smarthub-dev-green.app.cloud.gov/authenticated",
             "https://tta-smarthub-dev-green.app.cloud.gov/logout"
         ]
     }'

 # retrieve created id & secret
 cf service-key oauth-provider-dev oauth-key-dev-green

```

## Shared Services

In order to access a service from multiple 'spaces', run the following command:
`cf share-service SERVICE-INSTANCE -s OTHER-SPACE`

Currently, database restore is done by sharing lower-env db access into the prod environment, where the s3 db backups are located.
An automated script will run in that environment and run updates and migrations on the lower-env databases.

<!-- Links -->

[aws-config]: https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-quickstart.html#cli-configure-quickstart-config
[aws-install]: https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2.html
[cloudgov-bind]: https://cloud.gov/docs/deployment/managed-services/#bind-the-service-instance
[cloudgov-deployer]: https://cloud.gov/docs/services/cloud-gov-service-account/
[cloudgov-service-keys]: https://cloud.gov/docs/services/s3/#interacting-with-your-s3-bucket-from-outside-cloudgov
[cf-install]: https://docs.cloudfoundry.org/cf-cli/install-go-cli.html
[PR#71]: https://github.com/adhocteam/Head-Start-TTADP/pull/71
[tf]: https://www.terraform.io/downloads.html
[tf-vars]: https://www.terraform.io/docs/configuration/variables.html#variable-definitions-tfvars-files



## Creating and Applying a Deploy Key

In order for CircleCi to correctly pull the latest code from Github, we need to create and apply a SSH token to both Github and CircleCi.  This has already been done for existing environments but documented here for future reference

The following links outline the steps to take:
https://circleci.com/docs/github-integration/#create-a-github-deploy-key
https://docs.github.com/en/authentication/connecting-to-github-with-ssh/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent

Steps to create and apply deploy token:

1. Open the Git Bash CMD window
2. Enter the following command with your github (admin) e-mail: ssh-keygen -t rsa -b 4096 -C "your_email@example.com"
3. When prompted to enter a file name leave blank and press ENTER
4. When prompted to enter a PASSPHRASE leave blank and press ENTER (twice)
5. Search for the file created with the name "id_rsa"
6. Notice that two files have been created private and public in the .ssh folder
7. Open the public file and copy the entire contents of the file
8. In Github to the TTAHUB project and click 'Settings' in the top right corner
9. Under 'Security' click 'Deploy Keys' then 'Add deploy Key'
10. Give the key a name 'TTAHUB' and paste the private key contents, CHECK 'Allow write access' then click 'Add Key'
11. Open the private key file that was created and copy the entire contents of the file
12. Go to CircleCi and open the 'Head-Start-TTADP' project
13. Click 'Project settings' in the top right corner
14. Click 'SSH keys' and scroll down to the section 'Additional SSH Keys'
15. Click 'Add SSH Key', in 'Hostname' enter github.com then paste the contents of the private file in 'Private Key' section
16. Click 'Add SSH Key'


## Removing, creating and binding a service from the command line

In the past, we've needed to destroy and recreate particular services (for example, redis). This can be done through the Cloud.gov UI, through the Terraform architecture, and through the cloud foundry command line interface. The following are instructions for using the cloud foundry CLI (`cf`) for this.

- Login and target the environment you wish to make changes to. (`cf login --sso`).
- You can use `cf services` to list your services
- Remember that you can use `cf help COMMAND` to get the documentation for a particular command

To delete and recreate a service (this should not be done lightly, as it is a destructive action)

1 Unbind a service:
`cf us APP_NAME SERVICE`
ex:
`cf us tta-smarthub-staging ttahub-redis-staging`

2 Delete a service:
`cf ds SERVICE`
ex:
`cf ds ttahub-redis-staging`

3 Create a service:
`cf cs SERVICE_TYPE SERVICE_LABEL SERVICE`
ex:
`cf cs aws-elasticache-redis redis-dev ttahub-redis-staging`

4 Bind a service:
`cf bs APP_NAME SERVICE`
ex:
`cf bs ttahub-smarthub-staging ttahub-redis-staging`

5. Trigger a redeploy through the Circle CI UI (rather than restaging)

6. Finally, you may need to reconfigure the network policies to allow the app to connect to the virus scanning api. Check your network policies with:
   `cf network-policies`
   If you see nothing there, you'll need to add an appropriate policy.
   `cf add-network-policy tta-smarthub-APP_NAME clamav-api-ttahub-APP_NAME --protocol tcp --port 9443`
   ex:
   `cf add-network-policy tta-smarthub-dev clamav-api-ttahub-dev --protocol tcp --port 9443`
   You may need to connect across spaces (for example, our clamav-api-ttahub-dev app is shared by all of our ephemeral environments). If so, use the -s flag.
   ex:
   `cf add-network-policy tta-smarthub-staging -s ttahub-dev clamav-api-ttahub-dev --protocol tcp --port 9443`

