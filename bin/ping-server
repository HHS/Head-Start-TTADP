#!/bin/bash

# Usage: ./bin/ping-server <port> [hostname]

# Ensure port is provided
if [ -z "$1" ]; then
  echo "Error: Port is required."
  echo "Usage: $0 <port> [hostname]"
  exit 1
fi

PORT=$1
HOSTNAME=${2:-localhost} # Default to 'localhost' if hostname is not provided

# Retry configuration
attempt_counter=0
max_attempts=10

echo "Pinging server at http://${HOSTNAME}:${PORT}..."

until $(curl --output /dev/null --max-time 10 --silent --head --fail http://${HOSTNAME}:${PORT}); do
    if [ ${attempt_counter} -eq ${max_attempts} ]; then
        echo "Error: Max attempts reached. Server at ${HOSTNAME}:${PORT} is not responding."
        exit 1
    fi

    attempt_counter=$((attempt_counter + 1))
    echo "Attempt ${attempt_counter}/${max_attempts}: Retrying in 30 seconds..."
    sleep 30
done

echo "Success: Server at ${HOSTNAME}:${PORT} is responding."
