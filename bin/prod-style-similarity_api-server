#!/bin/bash
#
# This script sets up the similarity_api server as run-owasp-scan expects it

# Setup script to fail on any error and log all output
set -e
set -o pipefail
exec > >(tee -a "setup.log") 2>&1

echo "Starting similarity_api server setup..."

# Check for existence of required docker-compose files
if [ ! -f "docker-compose.dss.similarity_api.yml" ]; then
    echo "Error: docker-compose.dss.similarity_api.yml does not exist."
    exit 1
fi

if [ ! -f "docker-compose.dss.yml" ]; then
    echo "Error: Node.js docker-compose.dss.yml does not exist."
    exit 1
fi

# Remove old build directory (if applicable)
if [ -d "build/" ]; then
    echo "Removing old build directory..."
    rm -r build/
else
    echo "No old build directory found, skipping removal."
fi

# Install Python dependencies
echo "Installing Python dependencies..."
docker compose -f docker-compose.dss.similarity_api.yml run --rm similarity_api pip install -r /app/requirements.txt

# Set up the database using the Node.js app
echo "Setting up the database using the Node.js app..."
docker compose -f docker-compose.dss.yml run --rm server yarn db:migrate:ci

# Start services for the Python app
echo "Starting services for the similarity_api app..."
docker compose -f docker-compose.dss.similarity_api.yml up -d

echo "similarity_api server setup completed successfully."
