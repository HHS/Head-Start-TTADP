#!/bin/bash -x
declare lr=">>>>>>>>"
declare -i exit_code=0

check_exit() {
    if [[ "$1" -ne 0 ]]; then
        echo "$lr last test command failed"
        ((exit_code++))
    fi
}

log() {
    echo "$lr $*"
}

run_root_tests() {
	touch coverage-expected
	JEST_JUNIT_OUTPUT_NAME=root.xml \
		node \
			--expose-gc \
			./node_modules/.bin/jest \
			src/*.js \
			--coverage \
			--coverageDirectory="$(pwd)"/coverage/src/root \
			--collectCoverageFrom="src/*.{js,ts}" \
			"${jest_common_args[@]}"

	check_exit "$?"
}

run_target_tests() {
	local target="$1"

	touch coverage-expected
	JEST_JUNIT_OUTPUT_NAME="$target".xml \
		node \
			--expose-gc \
			./node_modules/.bin/jest \
			src/"$target" \
			--coverage \
			--coverageDirectory="$(pwd)"/coverage/src/"$target" \
			--collectCoverageFrom="src/$target/**/!(*CLI).{js,ts}" \
			"${jest_common_args[@]}"

	check_exit "$?"
}

run_tools_tests() {
	JEST_JUNIT_OUTPUT_NAME="tools".xml \
		node \
			--expose-gc \
			./node_modules/.bin/jest \
			tools \
			--coverage=false \
			"${jest_common_args[@]}"

	check_exit "$?"
}

main(){
    export JEST_JUNIT_OUTPUT_DIR=reports
    export JEST_JUNIT_ADD_FILE_ATTRIBUTE=1
    export POSTGRES_USERNAME=postgres
    export POSTGRES_DB=ttasmarthub
    export CURRENT_USER_ID=5
    export CI=true

    jest_common_args=(
        --colors
        --reporters=jest-junit
        --reporters=default
        --verbose
        --testLocationInResults
        --runInBand
        --silent
        --logHeapUsage
        --forceExit
    )

    targets=("root" "lib" "middleware" "models" "policies" "routes" "scopes" "services" "widgets" "goalServices" "tools")
	selected_targets=()

	if [[ -n "$CIRCLE_NODE_TOTAL" && "$CIRCLE_NODE_TOTAL" -gt 1 && -n "$CIRCLE_NODE_INDEX" ]]; then
		if command -v circleci >/dev/null 2>&1; then
			readarray -t selected_targets < <(printf "%s\n" "${targets[@]}" | circleci tests split --split-by=timings)
		else
			selected_targets=("${targets[@]}")
		fi
	else
		selected_targets=("${targets[@]}")
	fi

	if [[ ${#selected_targets[@]} -eq 0 ]]; then
		selected_targets=("${targets[@]}")
	fi

	for target in "${selected_targets[@]}"; do
		case "$target" in
			root)
				run_root_tests
				;;
			tools)
				run_tools_tests
				;;
			*)
				run_target_tests "$target"
				;;
		esac
	done

	if [[ $exit_code -ne 0 ]]; then
        echo
        log "Errors occurred during script execution"
   	fi

    exit "$exit_code"
}

main
