test_api:
    executor: docker-postgres-executor
    steps:
      - attach_workspace:
          at: .
      - setup_remote_docker:
          version: default
      - run:
          name: Start server
          command: |
            yarn build
            BYPASS_AUTH=true CURRENT_USER_ID=5 yarn start:ci
          background: true
      - run:
          name: Run migrations ci
          command: yarn db:migrate:ci
      - run:
          name: Seed database
          command: yarn db:seed:ci
      - run:
          name: Wait for server to start
          command: ./bin/ping-server 3000
      - run:
          name: Monitor database
          command: |
            docker attach  $(docker ps | grep postgres | awk '{print $1}')
          background: true
      - run:
          name: Install playwright dependencies
          command: |
            npx playwright install
      - run:
          name: Run playwright tests
          command: yarn e2e:api
      - store_artifacts:
          path: tests/api
    resource_class: large
