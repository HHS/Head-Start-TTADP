version: "3.7"
services:
  test-backend:
    build:
      context: .
      dockerfile: ./Dockerfile.test
      cache_from: 
        - node:18.18.2  # Using the base image as a cache source
        - node:18.18.2-slim
        - node:18.18.2-alpine
        - head-start-ttadp-backend:latest
      target: backend
    command: yarn server
    user: ${CURRENT_USER:-root}
    ports:
      - "8080:8080"
    depends_on:
      - test-db
    environment:
      - POSTGRES_HOST=test-db
    extra_hosts:
      - "${ITAMS_MD_HOST:-sftp.itams.ohs.acf.hhs.gov}:0.0.0.0"
    volumes:
      - "./src/:/app/src/:rw"
      - "./tests/:/app/tests/:rw"
      - "./config/:/app/config:rw"
      - "./packages:/packages:ro"
      - ".env:/app/.env:ro"
  test-frontend:
    build:
      context: .
      dockerfile: ./Dockerfile.test
      cache_from: 
        - node:18.18.2  # Using the base image as a cache source
        - node:18.18.2-slim
        - node:18.18.2-alpine
        - head-start-ttadp-frontend:latest
      target: frontend
    env_file: .env
    command: yarn start
    user: ${CURRENT_USER:-root}
    stdin_open: true
    ports:
      - "3000:3000"
    volumes:
      - "./frontend/src:/app/src:rw"
      - "./frontend/public:/app/public:rw"
      - "./frontend/scripts:/app/scripts:rw"
      - "./frontend/package.json:/app/package.json:rw"
      - "./packages:/packages:ro"
      - ".env:/app/.env:ro"
  test-worker:
    build:
      context: .
      dockerfile: ./Dockerfile.test
      cache_from: 
        - node:18.18.2  # Using the base image as a cache source
        - node:18.18.2-slim
        - node:18.18.2-alpine
        - head-start-ttadp-worker:latest
      target: backend
    command: yarn worker
    env_file: .env
    depends_on:
      - db
      - redis
    volumes:
      - "./src/:/app/src/:rw"
      - "./tests/:/app/tests/:rw"
      - "./config/:/app/config:rw"
      - ".env:/app/.env:ro"

