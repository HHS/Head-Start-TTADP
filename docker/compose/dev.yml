x-project-labels: &project-labels
  com.ttahub.project: head-start-ttadp
  com.ttahub.stack: dev

services:
  db:
    image: postgres:15.12
    labels: *project-labels
    environment:
      POSTGRES_USER: ${POSTGRES_USERNAME:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-something_secret}
      POSTGRES_DB: ${POSTGRES_DB:-ttasmarthub}
    ports:
      - "5432:5432"
    volumes:
      - db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USERNAME:-postgres} -d ${POSTGRES_DB:-ttasmarthub}"]
      interval: 5s
      timeout: 5s
      retries: 12
    shm_size: 1g

  redis:
    image: redis:6.2.6
    labels: *project-labels
    command: ["redis-server", "--requirepass", "${REDIS_PASS:-SUPERSECUREPASSWORD}"]
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASS:-SUPERSECUREPASSWORD}", "ping"]
      interval: 5s
      timeout: 5s
      retries: 12

  backend:
    labels: *project-labels
    build:
      context: ../..
      dockerfile: docker/images/node-dev.Dockerfile
    entrypoint: ["/workspace/docker/scripts/ensure-deps.sh", "backend"]
    command: ["yarn", "server"]
    env_file:
      - ../../.env
    environment:
      POSTGRES_HOST: db
      REDIS_HOST: redis
      SMTP_HOST: mailcatcher
      YARN_CACHE_FOLDER: /yarn-cache
      NEW_RELIC_ENABLED: "false"
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test:
        - "CMD"
        - "node"
        - "-e"
        - "const http=require('http');const req=http.get('http://127.0.0.1:8080/api/user',(res)=>process.exit(res.statusCode===200?0:1));req.on('error',()=>process.exit(1));req.setTimeout(3000,()=>{req.destroy();process.exit(1);});"
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 20s
    ports:
      - "8080:8080"
    volumes:
      - ../../:/workspace:rw
      - backend-node-modules:/workspace/node_modules
      - backend-yarn-cache:/yarn-cache

  worker:
    labels: *project-labels
    profiles: ["full"]
    build:
      context: ../..
      dockerfile: docker/images/node-dev.Dockerfile
    entrypoint: ["/workspace/docker/scripts/ensure-deps.sh", "backend"]
    command: ["yarn", "worker"]
    env_file:
      - ../../.env
    environment:
      POSTGRES_HOST: db
      REDIS_HOST: redis
      SMTP_HOST: mailcatcher
      YARN_CACHE_FOLDER: /yarn-cache
      NEW_RELIC_ENABLED: "false"
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ../../:/workspace:rw
      - backend-node-modules:/workspace/node_modules
      - worker-yarn-cache:/yarn-cache

  frontend:
    labels: *project-labels
    build:
      context: ../..
      dockerfile: docker/images/node-dev.Dockerfile
    working_dir: /workspace/frontend
    entrypoint: ["/workspace/docker/scripts/ensure-deps.sh", "frontend"]
    command: ["yarn", "start"]
    env_file:
      - ../../.env
    environment:
      BACKEND_PROXY: http://backend:8080
      YARN_CACHE_FOLDER: /yarn-cache
      NODE_OPTIONS: --no-deprecation
    depends_on:
      backend:
        condition: service_healthy
    ports:
      - "3000:3000"
    stdin_open: true
    volumes:
      - ../../frontend:/workspace/frontend:rw
      - ../../packages:/workspace/packages:rw
      - ../../docker:/workspace/docker:ro
      - frontend-node-modules:/workspace/frontend/node_modules
      - frontend-yarn-cache:/yarn-cache

  mailcatcher:
    image: schickling/mailcatcher
    labels: *project-labels
    profiles: ["full"]
    ports:
      - "1025:1025"
      - "1080:1080"

  minio:
    image: minio/minio:RELEASE.2024-01-01T16-36-33Z
    labels: *project-labels
    profiles: ["full"]
    env_file:
      - ../../.env
    command: ["server", "/data", "--console-address", ":9001"]
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio-data:/data

  redis-commander:
    image: rediscommander/redis-commander:latest@sha256:19cd0c49f418779fa2822a0496c5e6516d0c792effc39ed20089e6268477e40a
    labels: *project-labels
    profiles: ["full"]
    environment:
      REDIS_HOSTS: local:redis:6379:0:${REDIS_PASS:-SUPERSECUREPASSWORD}
    ports:
      - "8081:8081"
    depends_on:
      redis:
        condition: service_healthy

  api-docs:
    image: redocly/redoc
    labels: *project-labels
    profiles: ["full"]
    environment:
      SPEC_URL: swagger/index.yaml
    ports:
      - "5003:80"
    volumes:
      - ../../docs/openapi:/usr/share/nginx/html/swagger:ro

networks:
  default:
    labels: *project-labels

volumes:
  db-data:
    labels: *project-labels
  redis-data:
    labels: *project-labels
  minio-data:
    labels: *project-labels
  backend-node-modules:
    labels: *project-labels
  frontend-node-modules:
    labels: *project-labels
  backend-yarn-cache:
    labels: *project-labels
  frontend-yarn-cache:
    labels: *project-labels
  worker-yarn-cache:
    labels: *project-labels
