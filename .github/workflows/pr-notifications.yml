name: Pull Request Notifications (Test)

on:
  pull_request:
    branches:
      - main
    types: [ready_for_review]

jobs:
  notify_slack:
    runs-on: ubuntu-latest
    steps:
      - name: Get PR body
        uses: actions/github-script@v7
        id: get-body
        with:
          script: return context.payload.pull_request.body;

      - name: Notify Slack when a PR to main is opened (test)
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN_TEST }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          PR_BODY: ${{ steps.get-body.outputs.result }}
        run: |
          extract_section() {
            echo "$PR_BODY" | awk -v section="## $1" '
              BEGIN {found=0}
              tolower($0) ~ tolower("^" section) {found=1; next}
              /^## / && found {exit}
              found {print}
            '
          }

          DESC=$(extract_section "Description of change" | head -c 400)
          TEST=$(extract_section "How to test" | head -c 400)
          ISSUES=$(extract_section "Issue" | head -c 400)

          PR_LINK="https://github.com/$GITHUB_REPOSITORY/pull/$PR_NUMBER"

          TEXT_MESSAGE=":rocket: *PR to main is now open!*\n>*Title:* $PR_TITLE\n>*Author:* @$PR_AUTHOR\n>*Description:* $DESC\n>*How to test:* $TEST\n>*Issues:* $ISSUES\n$PR_LINK"

          curl -X POST -H "Authorization: Bearer $SLACK_BOT_TOKEN" \
            -H 'Content-type: application/json;charset=utf-8' \
            --data "{
              \"channel\": \"github-test\",
              \"text\": \"$TEXT_MESSAGE\"
            }" https://slack.com/api/chat.postMessage
